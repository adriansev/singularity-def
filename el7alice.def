Bootstrap: yum
OSVersion: 7
MirrorURL: http://monitor.spacescience.ro/mirrors/centos/7/os/x86_64/
UpdateURL: http://monitor.spacescience.ro/mirrors/centos/7/updates/x86_64/
Include: yum curl yum-utils fuse3 fuse3-libs

%files
default.local.alice /etc/cvmfs/default.local

%startscript
# let's get latest version of iss pac
curl -fsSlk https://gist.githubusercontent.com/adriansev/60df81a5ed2e92182e635dbb0b283f94/raw/7087368bacab0427907e16214bbab05ef0e9c31d/cvmfs_iss.pac -o /tmp/cvmfs.pac


%help


%environment
${CVMFS_ALIEN_CACHE:=${HOME}/cvmfs-cache}
export CVMFS_ALIEN_CACHE

export SINGULARITY_BIND="${CVMFS_ALIEN_CACHE}:/var/lib/cvmfs"

#--fusemount "container:cvmfs2 $CONFIGREPO /cvmfs/$CONFIGREPO" \
#--fusemount "container:cvmfs2 cms.cern.ch /cvmfs/cms.cern.ch" \
##SINGULARITY_SCRATCH and SINGULARITY_SCRATCHDIR: Used to include a scratch directory within the container that is linked to a temporary directory.


%post
yum -y update && yum -y install https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum install -y cvmfs cvmfs-config-default cvmfs-fuse3

yum clean all && rm -rf /var/cache/yum;

%runscript
[[ ! -e "${CVMFS_ALIEN_CACHE}" ]] && { mkdir -p "${CVMFS_ALIEN_CACHE}" || { echo "Could not create the cvmfs external cache: CVMFS_ALIEN_CACHE"; exit 1;} }

export PATH="/cvmfs/alice.cern.ch/bin:${PATH}"
VERB="${1}"
shift
PKG="${1}"
shift

if [[ "${VERB}" == "load" ]]; then
    eval $(/cvmfs/alice.cern.ch/bin/alienv printenv VO_ALICE@${PKG});
elif [[ "${VERB}" == "enter" ]]; then
    /cvmfs/alice.cern.ch/bin/alienv enter VO_ALICE@${PKG};
else
    echo "No loaded or entered environment; usage: ${0} load|enter PACKAGE_NAME"
fi

[[ -n "${@}" ]] && exec "${@}" || bash

